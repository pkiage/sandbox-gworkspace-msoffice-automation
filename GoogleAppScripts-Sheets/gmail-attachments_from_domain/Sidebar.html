<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font: 13px/1.4 Arial, sans-serif; padding: 12px; }
      h2 { margin: 0 0 8px; font-size: 16px; }
      fieldset {
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 15px 20px;
        margin-bottom: 20px;
        background-color: #f9f9f9;
        max-width: 450px;
        width: 90%;
        margin-left: auto;
        margin-right: auto;
      }
      legend { padding: 0 6px; color: #444; }
      label { display: block; margin: 6px 0; }
      .row { display: flex; gap: 8px; }
      .row > div { flex: 1; }
      input[type="text"], input[type="email"], input[type="date"], input[type="number"] { width: 100%; padding: 6px; }
      .muted { color: #666; font-size: 12px; }
      .small { font-size: 11px; color:#555; }
      .btn { display: inline-block; padding: 8px 12px; border: 1px solid #888; border-radius: 6px; background:#f5f5f5; cursor:pointer; }
      .btn.primary { background:#1a73e8; color:#fff; border-color:#1a73e8; }
      .btnbar { display:flex; flex-wrap: wrap; gap:8px; margin-top: 6px; }
      .inline { display: inline-block; margin-left: 6px; }
      .help { background: #f9fbff; border: 1px solid #dfe8ff; padding: 8px; border-radius: 6px; margin-bottom: 10px; }
      .warn { color:#b33; }
      .ok { color:#2a7; }
      .section-title { margin: 2px 0 6px; font-weight: 600; }
    </style>
  </head>
  <body>
    <h2>List & (optionally) Save Email Attachments</h2>
    <div class="help">
      Uses the <b>active sheet</b>. If it’s not empty, you’ll be prompted to either append here or auto-create a new tab (and you can “remember” that choice).
      It logs: File Name, <i>File Type (MIME)</i>, Size, Subject, From/To, Date, and links. If “Save to Drive” is on, it also writes a Saved File URL.
    </div>

    <form id="f">
      <fieldset>
        <legend>Date basis</legend>
        <label>
          <input type="radio" name="dateBasis" id="basis_received" value="received">
          <b>Received (message)</b> — Only attachments from messages whose received date falls in your window.
        </label>
        <label>
          <input type="radio" name="dateBasis" id="basis_thread" value="thread">
          <b>Threaded (conversation)</b> — If a thread is active in your window, include <i>all</i> attachments from that thread (may include older ones).
        </label>
      </fieldset>

      <fieldset>
        <legend>Quick ranges</legend>
        <div class="btnbar">
          <span class="btn" onclick="pickMTD()">MTD</span>
          <span class="btn" onclick="pickQTD()">QTD</span>
          <span class="btn" onclick="pickYTD()">YTD</span>
          <span class="btn" onclick="pickSinceLastRun()">Since last run</span>
        </div>
        <div class="small" id="lastRunInfo"></div>
      </fieldset>

      <fieldset>
        <legend>Date</legend>
        <div class="row">
          <div>
            <div class="section-title">Mode</div>
            <label><input type="radio" name="dateMode" id="date_from" value="from"> From date → now</label>
            <label><input type="radio" name="dateMode" id="date_range" value="range"> Date range (inclusive)</label>
          </div>
          <div>
            <label>
              Start date
              <input id="fromDate" name="fromDate" type="date" placeholder="e.g., 2025-05-01" style="width: 110px;" required>
            </label>
            <label>
              End date
              <input id="endDate" name="endDate" type="date" placeholder="e.g., 2025-07-31" style="width: 110px;">
              <span class="muted">Inclusive: messages on this day are included.</span>
            </label>
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Year & Quarters</legend>
        <div class="row">
          <div>
            <label>
              Year
              <input id="quarterYear" type="number" placeholder="e.g., 2025" style="width: 80px;">
            </label>
            <div class="small">Pick year + one or more quarters, then click Apply.</div>
          </div>
          <div>
            <label><input type="checkbox" id="q1"> Q1 (Jan–Mar)</label>
            <label><input type="checkbox" id="q2"> Q2 (Apr–Jun)</label>
            <label><input type="checkbox" id="q3"> Q3 (Jul–Sep)</label>
            <label><input type="checkbox" id="q4"> Q4 (Oct–Dec)</label>
            <div class="btnbar"><span class="btn" onclick="applyQuarters()">Apply</span></div>
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Sender filter (optional)</legend>
        <label>
          Sender domain (fill this OR the email below)
          <input id="domain" name="domain" type="text" placeholder='e.g., @xyz.com'>
          <span class="muted">Example: <code>@example.com</code> → query adds <i>from:*@example.com</i></span>
        </label>
        <label>
          Specific sender email (fill this OR the domain above)
          <input id="senderEmail" name="senderEmail" type="email" placeholder="e.g., placeholder@example.com">
          <span class="muted">Example: <code>placeholder@example.com</code> → query adds <i>from:placeholder@example.com</i></span>
        </label>
        <div class="muted">Tip: Leave both blank to include all senders.</div>

        <div class="row">
          <div>
            <label>
              <input id="includeInline" name="includeInline" type="checkbox">
              Include inline images (often signature logos)
            </label>
          </div>
          <div>
            <label>
              Min size (KB)
              <input id="minSizeKB" name="minSizeKB" type="number" placeholder="e.g., 20" style="width: 80px;">
              <span class="muted">Example: <code>20</code> skips tiny icons</span>
            </label>
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Save to Drive</legend>
        <label>
          <input id="saveToDrive" name="saveToDrive" type="checkbox" onchange="toggleFolder()">
          Save matching file types to a Drive folder
        </label>
        <label id="folderRow">
          Drive Folder URL
          <input id="folderUrl" name="folderUrl" type="text" placeholder="e.g., https://drive.google.com/drive/folders/XXXXXXXXXXXXXXXX">
        </label>
        <div class="muted">
          Example: <code>https://drive.google.com/drive/folders/ABC123...</code>
        </div>
      </fieldset>

      <fieldset>
        <legend>Which file types to SAVE (listing is always logged)</legend>
        <div class="btnbar">
          <span class="btn" onclick="selectTypes(true)">Select All</span>
          <span class="btn" onclick="selectTypes(false)">Select None</span>
        </div>

        <label><input type="checkbox" name="types.pdf"   id="types_pdf"> PDFs <span class="muted inline">(e.g., invoices, reports)</span></label>
        <label><input type="checkbox" name="types.word"  id="types_word"> Word <span class="muted inline">(.doc, .docx)</span></label>
        <label><input type="checkbox" name="types.ppt"   id="types_ppt"> PowerPoint <span class="muted inline">(.ppt, .pptx)</span></label>
        <label><input type="checkbox" name="types.excel" id="types_excel"> Excel <span class="muted inline">(.xls, .xlsx)</span></label>
        <label><input type="checkbox" name="types.csvtsv" id="types_csvtsv"> CSV/TSV <span class="muted inline">(.csv, .tsv)</span></label>
        <label><input type="checkbox" name="types.txt"   id="types_txt"> Plain text <span class="muted inline">(.txt)</span></label>
        <label><input type="checkbox" name="types.json"  id="types_json"> JSON <span class="muted inline">(.json)</span></label>
        <label><input type="checkbox" name="types.images" id="types_images"> Images <span class="muted inline">(.png, .jpg, .gif, ...)</span></label>
        <label><input type="checkbox" name="types.archives" id="types_archives"> Archives <span class="muted inline">(.zip, .rar, .7z)</span></label>
        <label><input type="checkbox" name="types.code"  id="types_code"> Code <span class="muted inline">(.py, .js, .java, ...)</span></label>
        <label><input type="checkbox" name="types.other" id="types_other"> Other (catch-all)</label>
        <div class="muted">If nothing is checked here, files will be listed but <b>not saved</b>.</div>
      </fieldset>

      <div class="btnbar">
        <button type="button" class="btn primary" onclick="run()">Run</button>
        <button type="button" class="btn" onclick="resetToDefaults()">Reset to defaults</button>
      </div>

      <div id="status" class="muted" style="margin-top:8px;"></div>
    </form>

    <script>
      const PREFS = <?= JSON.stringify(prefs) ?>;

      function $(id){ return document.getElementById(id); }
      function setChecked(id, val){ const el=$(id); if (el) el.checked=!!val; }
      function setVal(id, val){ const el=$(id); if (el) el.value = (val ?? ''); }

      function yyyy(n){ return String(n).padStart(4,'0'); }
      function mm(n){ return String(n).padStart(2,'0'); }
      function dd(n){ return String(n).padStart(2,'0'); }
      function toInputDate(d){ return `${d.getFullYear()}-${mm(d.getMonth()+1)}-${dd(d.getDate())}`; }

      function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
      function startOfYear(d){ return new Date(d.getFullYear(), 0, 1); }
      function startOfQuarter(d){
        const qStartMonth = Math.floor(d.getMonth()/3)*3;
        return new Date(d.getFullYear(), qStartMonth, 1);
      }
      function quarterStart(year, qIndex){ return new Date(year, qIndex*3, 1); } // qIndex 0..3
      function quarterEnd(year, qIndex){ return new Date(year, qIndex*3 + 3, 0); } // last day prev month

      function hydrate() {
        // Date basis
        setChecked('basis_received', (PREFS.dateBasis || 'received') === 'received');
        setChecked('basis_thread',   (PREFS.dateBasis || 'received') === 'thread');

        // Last run info
        const lastRunISO = PREFS.lastRunISO || '';
        $('lastRunInfo').textContent = lastRunISO
          ? `Last run: ${lastRunISO.slice(0,10)}`
          : 'Last run: (none yet)';

        // Date mode + values
        const mode = (PREFS.dateMode || 'from');
        setChecked('date_from', mode === 'from');
        setChecked('date_range', mode === 'range');
        setVal('fromDate', PREFS.fromDate || '');
        setVal('endDate',  PREFS.endDate  || '');

        // Quarters default year = today
        const today = new Date();
        setVal('quarterYear', today.getFullYear());

        // Sender & filters
        setVal('domain', PREFS.domain || '');
        setVal('senderEmail', PREFS.senderEmail || '');
        setChecked('includeInline', PREFS.includeInline || false);
        setVal('minSizeKB', PREFS.minSizeKB ?? 20);

        // Save to Drive
        setChecked('saveToDrive', PREFS.saveToDrive || false);
        setVal('folderUrl', PREFS.folderUrl || '');
        toggleFolder();
      }

      function toggleFolder() {
        const show = $('saveToDrive').checked;
        $('folderUrl').disabled = !show;
        $('folderRow').style.opacity = show ? '1' : '0.5';
      }

      function selectTypes(val) {
        ['pdf','word','ppt','excel','csvtsv','txt','json','images','archives','code','other']
          .forEach(k => { $('types_'+k).checked = !!val; });
      }

      // ===== Quick ranges =====
      function pickMTD() {
        const today = new Date();
        const s = startOfMonth(today);
        $('date_from').checked = true; $('date_range').checked = false;
        $('fromDate').value = toInputDate(s);
        $('endDate').value = '';
        statusMsg('MTD selected (start of month → now).');
      }
      function pickQTD() {
        const today = new Date();
        const s = startOfQuarter(today);
        $('date_from').checked = true; $('date_range').checked = false;
        $('fromDate').value = toInputDate(s);
        $('endDate').value = '';
        statusMsg('QTD selected (start of quarter → now).');
      }
      function pickYTD() {
        const today = new Date();
        const s = startOfYear(today);
        $('date_from').checked = true; $('date_range').checked = false;
        $('fromDate').value = toInputDate(s);
        $('endDate').value = '';
        statusMsg('YTD selected (Jan 1 → now).');
      }
      function pickSinceLastRun() {
        const iso = PREFS.lastRunISO || '';
        if (!iso) { statusMsg('No previous run found yet.', false); return; }
        $('date_from').checked = true; $('date_range').checked = false;
        $('fromDate').value = iso.slice(0,10);
        $('endDate').value = '';
        statusMsg(`Since last run selected (${iso.slice(0,10)} → now).`);
      }

      // ===== Year + Quarter(s) =====
      function applyQuarters() {
        const year = parseInt($('quarterYear').value, 10);
        const qSel = [
          $('q1').checked,
          $('q2').checked,
          $('q3').checked,
          $('q4').checked
        ];
        const idxs = qSel.map((v,i)=>v?i:null).filter(v=>v!==null);
        if (!year || idxs.length === 0) {
          statusMsg('Pick a year and at least one quarter.', false);
          return;
        }
        const starts = idxs.map(i => quarterStart(year, i));
        const ends   = idxs.map(i => quarterEnd(year, i));
        const s = new Date(Math.min.apply(null, starts));
        const e = new Date(Math.max.apply(null, ends));
        $('date_from').checked = true; // we can use range; both work, but range is clearer
        $('date_range').checked = true;
        $('fromDate').value = toInputDate(s);
        $('endDate').value = toInputDate(e);
        statusMsg(`Applied ${idxs.length} quarter(s) in ${year}: ${$('fromDate').value} → ${$('endDate').value} (inclusive).`);
      }

      function resetToDefaults() {
        // Basis
        $('basis_received').checked = true;
        $('basis_thread').checked = false;

        // Dates
        $('date_from').checked = true;
        $('date_range').checked = false;
        $('fromDate').value = '';
        $('endDate').value = '';

        // Quarters
        const today = new Date();
        $('quarterYear').value = today.getFullYear();
        ['q1','q2','q3','q4'].forEach(id => $(id).checked = false);

        // Filters
        $('domain').value = '';
        $('senderEmail').value = '';
        $('includeInline').checked = false;
        $('minSizeKB').value = 20;

        // Drive
        $('saveToDrive').checked = false;
        $('folderUrl').value = '';
        toggleFolder();

        // Types
        selectTypes(false);
        $('types_pdf').checked = true;
        $('types_excel').checked = true;
        $('types_csvtsv').checked = true;

        statusMsg('Reset to defaults. Choose a date mode/basis and fill dates or use a quick range.');
      }

      function statusMsg(msg, ok=true) {
        const el = $('status');
        el.textContent = msg;
        el.className = ok ? 'ok' : 'warn';
      }

      function collectForm() {
        // dateBasis & dateMode
        const dateBasis = $('basis_thread').checked ? 'thread' : 'received';
        const dateMode  = $('date_range').checked ? 'range' : 'from';
        return {
          dateBasis,
          dateMode,
          fromDate: $('fromDate').value.trim(),
          endDate:  $('endDate').value.trim(),
          domain: $('domain').value.trim(),
          senderEmail: $('senderEmail').value.trim(),
          includeInline: $('includeInline').checked,
          minSizeKB: $('minSizeKB').value ? Number($('minSizeKB').value) : 0,
          saveToDrive: $('saveToDrive').checked,
          folderUrl: $('folderUrl').value.trim(),
          types: {
            pdf: $('types_pdf').checked,
            word: $('types_word').checked,
            ppt: $('types_ppt').checked,
            excel: $('types_excel').checked,
            csvtsv: $('types_csvtsv').checked,
            txt: $('types_txt').checked,
            json: $('types_json').checked,
            images: $('types_images').checked,
            archives: $('types_archives').checked,
            code: $('types_code').checked,
            other: $('types_other').checked
          }
        };
      }

      function run() {
        statusMsg('Running… this may take a bit depending on your mailbox size.', true);
        const form = collectForm();
        google.script.run
          .withSuccessHandler(res => { statusMsg(res.message || 'Done.'); })
          .withFailureHandler(err => { statusMsg(err.message || String(err), false); })
          .runAttachmentJobFromSidebar(form);
      }

      hydrate();
    </script>
  </body>
</html>
